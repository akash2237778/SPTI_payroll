{% extends 'base.html' %}

{% block content %}
<div class="dashboard-grid">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon"></div>
            <div class="logo-text">SPTI Payroll</div>
        </div>

        <nav style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="{% url 'dashboard' %}" style="text-decoration: none;">
                <div style="padding: 1rem; color: var(--text-secondary); cursor: pointer; transition: 0.3s;"
                    onmouseover="this.style.color='white'" onmouseout="this.style.color='#9ca3af'">
                    üìä Dashboard
                </div>
            </a>
            <a href="{% url 'monthly_report' %}" style="text-decoration: none;">
                <div style="padding: 1rem; color: var(--text-secondary); cursor: pointer; transition: 0.3s;"
                    onmouseover="this.style.color='white'" onmouseout="this.style.color='#9ca3af'">
                    üìÖ Monthly Report
                </div>
            </a>
            <div
                style="background: rgba(139, 92, 246, 0.1); color: #c4b5fd; padding: 1rem; border-radius: 12px; font-weight: 500; border: 1px solid rgba(139, 92, 246, 0.2); cursor: pointer;">
                üïê Shifts
            </div>
            <a href="{% url 'settings' %}" style="text-decoration: none;">
                <div style="padding: 1rem; color: var(--text-secondary); cursor: pointer; transition: 0.3s;"
                    onmouseover="this.style.color='white'" onmouseout="this.style.color='#9ca3af'">
                    ‚öôÔ∏è Settings
                </div>
            </a>
        </nav>

        <div style="margin-top: auto; padding-top: 2rem; color: var(--text-secondary); font-size: 0.8rem;">
            <div>System Status: <span style="color: #34d399">‚óè Online</span></div>
            <div style="margin-top: 0.5rem;">v1.3.0 Shifts</div>
        </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
        <div class="sync-section">
            <div>
                <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">Shift Management</h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">Configure shifts and assign employees</p>
            </div>
            <button onclick="showAddShiftModal()" class="btn-glow">
                ‚ûï Add New Shift
            </button>
        </div>

        <!-- Shifts List -->
        <div class="table-wrapper" style="margin-bottom: 2rem;">
            <div class="table-header">
                <h2 class="table-title">üìã Available Shifts</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Shift Name</th>
                        <th>Type</th>
                        <th>Time</th>
                        <th>Hours</th>
                        <th>Break</th>
                        <th>Night Allowance</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shift in shifts %}
                    <tr>
                        <td style="font-weight: 500; color: white;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if shift.shift_type == 'NIGHT' %}
                                <span style="font-size: 1.2rem;">üåô</span>
                                {% elif shift.shift_type == 'DAY' %}
                                <span style="font-size: 1.2rem;">‚òÄÔ∏è</span>
                                {% else %}
                                <span style="font-size: 1.2rem;">üîÑ</span>
                                {% endif %}
                                {{ shift.name }}
                            </div>
                        </td>
                        <td>
                            <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;
                                {% if shift.shift_type == 'NIGHT' %}background: rgba(139, 92, 246, 0.2); color: #c4b5fd;
                                {% elif shift.shift_type == 'DAY' %}background: rgba(52, 211, 153, 0.2); color: #6ee7b7;
                                {% else %}background: rgba(251, 191, 36, 0.2); color: #fcd34d;{% endif %}">
                                {{ shift.get_shift_type_display }}
                            </span>
                        </td>
                        <td style="font-family: 'Space Grotesk'; color: var(--text-secondary);">
                            {{ shift.start_time|time:"H:i" }} - {{ shift.end_time|time:"H:i" }}
                            {% if shift.is_night_shift %}
                            <span style="color: #c4b5fd; font-size: 0.75rem;">(crosses midnight)</span>
                            {% endif %}
                        </td>
                        <td style="color: #c4b5fd; font-weight: 600;">{{ shift.working_hours }}h</td>
                        <td style="color: var(--text-secondary); font-size: 0.85rem;">
                            {% if shift.break_start_time %}
                            {{ shift.break_start_time|time:"H:i" }} - {{ shift.break_end_time|time:"H:i" }}
                            {% else %}
                            No break
                            {% endif %}
                        </td>
                        <td style="color: #fbbf24; font-weight: 600;">
                            {% if shift.night_shift_allowance > 0 %}
                            +{{ shift.night_shift_allowance }}%
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if shift.is_active %}
                            <span style="color: #34d399;">‚óè Active</span>
                            {% else %}
                            <span style="color: #9ca3af;">‚óã Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button
                                    onclick="editShift({{ shift.id }}, '{{ shift.name }}', '{{ shift.shift_type }}', '{{ shift.start_time|time:"
                                    H:i" }}', '{{ shift.end_time|time:"H:i" }}' , {{ shift.working_hours
                                    }}, '{{ shift.break_start_time|time:"H:i"|default:"" }}'
                                    , '{{ shift.break_end_time|time:"H:i"|default:"" }}' , {{
                                    shift.exclude_break|yesno:"true,false" }}, {{ shift.night_shift_allowance }}, {{
                                    shift.is_active|yesno:"true,false" }})"
                                    style="background: rgba(139, 92, 246, 0.2); color: #c4b5fd; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"
                                    onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'"
                                    onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'">
                                    Edit
                                </button>
                                <button onclick="deleteShift({{ shift.id }}, '{{ shift.name }}')"
                                    style="background: rgba(248, 113, 113, 0.2); color: #fca5a5; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"
                                    onmouseover="this.style.background='rgba(248, 113, 113, 0.3)'"
                                    onmouseout="this.style.background='rgba(248, 113, 113, 0.2)'">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No shifts configured yet. Click "Add New Shift" to create one.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Employee Shift Assignments -->
        <div class="table-wrapper">
            <div class="table-header">
                <h2 class="table-title">üë• Employee Shift Assignments</h2>
                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                    Assign shifts to employees (leave unassigned for auto-detection)
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Employee ID</th>
                        <th>Current Shift</th>
                        <th>Assign Shift</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                    <tr>
                        <td style="font-weight: 500; color: white;">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <div
                                    style="width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                                    {{ emp.name|make_list|first }}
                                </div>
                                {{ emp.name }}
                            </div>
                        </td>
                        <td style="color: var(--text-secondary);">{{ emp.employee_id }}</td>
                        <td>
                            {% if emp.shift %}
                            <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 500;
                                {% if emp.shift.shift_type == 'NIGHT' %}background: rgba(139, 92, 246, 0.2); color: #c4b5fd;
                                {% elif emp.shift.shift_type == 'DAY' %}background: rgba(52, 211, 153, 0.2); color: #6ee7b7;
                                {% else %}background: rgba(251, 191, 36, 0.2); color: #fcd34d;{% endif %}">
                                {{ emp.shift.name }}
                            </span>
                            {% else %}
                            <span style="color: var(--text-secondary); font-style: italic;">Auto-detect</span>
                            {% endif %}
                        </td>
                        <td>
                            <select id="shift_{{ emp.id }}"
                                style="padding: 0.5rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white; width: 200px;">
                                <option value="">Auto-detect</option>
                                {% for shift in shifts %}
                                <option value="{{ shift.id }}" {% if emp.shift and emp.shift.id == shift.id %}selected{% endif %}>
                                    {{ shift.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <button onclick="assignShift({{ emp.id }})"
                                style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: 0.2s;"
                                onmouseover="this.style.background='#7c3aed'"
                                onmouseout="this.style.background='var(--primary)'">
                                Assign
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
</div>

<!-- Add/Edit Shift Modal -->
<div id="shiftModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 2rem; border-radius: 16px; width: 90%; max-width: 600px; border: 1px solid rgba(255,255,255,0.1);">
        <h2 id="modalTitle" style="margin: 0 0 1.5rem 0; color: white;">Add New Shift</h2>
        <form id="shiftForm" onsubmit="saveShift(event)">
            <input type="hidden" id="shift_id" name="shift_id">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Shift
                        Name *</label>
                    <input type="text" id="name" name="name" required
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                </div>

                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Shift
                        Type *</label>
                    <select id="shift_type" name="shift_type" required
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                        <option value="DAY">Day Shift</option>
                        <option value="NIGHT">Night Shift</option>
                        <option value="GENERAL">General/Flexible</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Start
                        Time *</label>
                    <input type="time" id="start_time" name="start_time" required
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                </div>

                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">End
                        Time *</label>
                    <input type="time" id="end_time" name="end_time" required
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                </div>

                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Working
                        Hours *</label>
                    <input type="number" step="0.5" min="1" max="24" id="working_hours" name="working_hours" required
                        value="8"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Break
                        Start Time</label>
                    <input type="time" id="break_start_time" name="break_start_time"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                </div>

                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Break
                        End Time</label>
                    <input type="time" id="break_end_time" name="break_end_time"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Night
                        Allowance (%)</label>
                    <input type="number" step="0.01" min="0" max="100" id="night_shift_allowance"
                        name="night_shift_allowance" value="0"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                </div>

                <div style="display: flex; flex-direction: column; gap: 0.5rem; justify-content: flex-end;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="exclude_break" name="exclude_break" checked
                            style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="color: white; font-size: 0.9rem;">Exclude break from hours</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="is_active" name="is_active" checked
                            style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="color: white; font-size: 0.9rem;">Active</span>
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="closeShiftModal()"
                    style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem;">
                    Cancel
                </button>
                <button type="submit" class="btn-glow">
                    üíæ Save Shift
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function showAddShiftModal() {
        document.getElementById('modalTitle').textContent = 'Add New Shift';
        document.getElementById('shiftForm').reset();
        document.getElementById('shift_id').value = '';
        document.getElementById('shiftModal').style.display = 'flex';
    }

    function editShift(id, name, type, start, end, hours, breakStart, breakEnd, excludeBreak, allowance, active) {
        document.getElementById('modalTitle').textContent = 'Edit Shift';
        document.getElementById('shift_id').value = id;
        document.getElementById('name').value = name;
        document.getElementById('shift_type').value = type;
        document.getElementById('start_time').value = start;
        document.getElementById('end_time').value = end;
        document.getElementById('working_hours').value = hours;
        document.getElementById('break_start_time').value = breakStart;
        document.getElementById('break_end_time').value = breakEnd;
        document.getElementById('exclude_break').checked = excludeBreak;
        document.getElementById('night_shift_allowance').value = allowance;
        document.getElementById('is_active').checked = active;
        document.getElementById('shiftModal').style.display = 'flex';
    }

    function closeShiftModal() {
        document.getElementById('shiftModal').style.display = 'none';
    }

    function saveShift(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        fetch('{% url "shifts" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úì ' + data.message);
                    location.reload();
                } else {
                    alert('‚úó ' + data.message);
                }
            })
            .catch(error => {
                alert('‚úó Error saving shift');
                console.error('Error:', error);
            });
    }

    function deleteShift(shiftId, shiftName) {
        if (!confirm(`Are you sure you want to delete "${shiftName}"?`)) {
            return;
        }

        fetch(`/api/shift/${shiftId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úì ' + data.message);
                    location.reload();
                } else {
                    alert('‚úó ' + data.message);
                }
            })
            .catch(error => {
                alert('‚úó Error deleting shift');
                console.error('Error:', error);
            });
    }

    function assignShift(employeeId) {
        const shiftId = document.getElementById(`shift_${employeeId}`).value;
        const formData = new FormData();
        formData.append('shift_id', shiftId);

        fetch(`/api/employee/${employeeId}/assign-shift/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úì ' + data.message);
                    location.reload();
                } else {
                    alert('‚úó ' + data.message);
                }
            })
            .catch(error => {
                alert('‚úó Error assigning shift');
                console.error('Error:', error);
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}